---
layout: post
title: "高并发网站的基本架构"
description: ""
category: 
tags: []
---
{% include JB/setup %}
五百年又五百年，时间来到了二零一五年，花果山随着城市改造建设，成为了一个著名的旅游景点，这里风景秀丽，人来人往，虽然时不时弥漫着雾气缭绕、遍地垃圾，但也算是人间仙境了。悟空仗着高龄的年岁，享受着国家的补贴，也过上了不愁吃穿的日子，但是面对着天天被人当猴看的生活，不免也有了一些厌倦，于是这天，悟空背着动物园管理师傅，一个筋斗云飞出了花果山，想找八戒去唠会嗑。

经过几番打听，当年的高老庄已经改名为了石家庄，于是悟空飞抵石家庄，来到了一家科技公司门前。原来，八戒通过这些年的打拼，已经成为一家科技公司的资深程序猿，大家尊称其为“猪老板儿”。悟空在门卫处打听到了猪老板儿的办公室，一路飞奔上楼，想到即将见到多年未见的好友，激动不已。

来到办公室门前，悟空推开门，只见八戒一手划弄着手机，一手敲击着键盘，眼睛笑眯眯的盯着屏幕。悟空轻轻的将门关上，此时八戒突然感到阵阵阴风，扔开手机，瞟眼望了一眼门口，发现是大师兄来了，惊喜万分，忙喊：“猴哥，你怎么来了，吓死我了，还以为领导呢。”，悟空道：“大猪，你小子这么多年还是没变啊，滑里滑头的，我在花果山闷得慌，找你来玩耍玩耍。你在那看啥呢？”

“猴哥，你可不知，我现在也是响当当的IT界型男了，公司里的技术大拿，你看我正在把咱们当年取的经书发布到网上呢，你可不知道，咱这经书可成了绝版了，现在浏览量老高了，全球的人都在读咱们的经书呢。”

“网上？全球？大猪，这些都是什么？俺老孙怎么从没听过这些东西。”

“猴哥啊，看来这些年你天天除了被人当猴看，还真没别的事儿了，现在都什么年代了，信息大爆炸时代啊，没有人再闲的受什么九九八十一难跑那么老远去取经了，现在都是网络时代了，直接打开浏览器，想看什么就能看什么，老方便了”，这时，八戒把悟空领到电脑屏幕前，指着经书网说，“看看，这就是我架构的经书网，已经成为我们公司的招牌产品了，大数据量、高并发，老猛了。”

悟空望着屏幕上下左右打量了一番，上面有经书是没错，但这个大数据量，高并发又是什么呢？

八戒看出了悟空的疑惑，继续道：“师兄，看看这儿，当前在线人数一千九百万，知道这意味着什么么?恩？我告你，这可是一千九百万人在我这台服务器里玩耍呢，一千九百万啊，这可比你身上的毛都多呢。”

悟空不经感叹，“好牛逼！“，悟空的性格向来就是有孔就钻的人，便向八戒道来，“歹俺老孙也进去玩玩”，随后便化身成了一条http请求，钻入网络链路中去了。

八戒大急，猴脾气就是猴脾气，毛毛躁躁的，也不问清楚就往里钻，我等着你被打回来吧。果然，这时屏幕上出现了个猴头，悟空叫道，“大猪啊，我怎么进不去啊，那里有俩看门的真心厉害啊，俺老孙实在打不过他们。”

“猴哥，你看你急的，也不等我说句话就往里钻，我得给你一样法宝，你才能进去。”

“法宝？那你不早早拿来，非让我在里面丢了脸，你是不是跟我过意不去？”

八戒嘟着嘴，一头怨气，拿出了一件宝贝递给了悟空，“猴哥，这东西叫cookie，里面存放这你的sessionid，有了这玩意，那些看大门的就能查询到你的信息，让你过去了。”

悟空二话不说，一把夺过cookie，装进怀中，转身钻了进去。经过一路峰回路转，悟空停到了一座城池前，只见城门上悬挂着一个大大的招牌---“F5”，悟空问道，“大猪，这个F5是个什么东西，我怎么才能过去？”

八戒说，“猴哥，F5是一座负载均衡城池，这座城身后有十多条路可以走，你看到从你身边走过的兄弟们没，他们被F5均衡的分配到了这十多条路上，每条路都会通往一个城池，要不大家都走一条路，那座城肯定挤崩个哒，你说是不。咱公司有钱，能买的起F5这座城池，其他那些没钱的公司就只能在路口派一些小兵（软件）来实现负载均衡了，比如Apache兵、Nginx兵。猴哥，你就往里走吧，进去后他会自动把你传送到下条路的。”

悟空松了口气，径直走了进去，果然真像大猪所说，城池里全是四通八达的传送带，悟空被推倒了一条传送带上，缓缓的送上了一条宽阔的大道。继续往前走，没过多久，悟空便停了下来，只见前面云雾缭绕，隐约看到一个路牌，上面写着分布式缓存仓库，悟空问到，“大猪，这里雾气腾腾的，是个什么地方？”

大猪道，“别急，先让我来五十个俯卧撑再说”，只见大猪双手贴上白纸，俯身下地，标标准准的做了二十个俯卧撑，随后哼着粗气站起来说，“猴哥，这个叫做分布式缓存服务器，他呢其实就是一个仓库，你的身份信息，档案信息都在这里面呢，当然，里面还有一些现成的货物，你可以直接取走。其实，以前，这个仓库都是建在后面的每座城池中的，但是随着到访人员的增多，我们不得不建立更多的城池，这时就会出现了一个问题，我第一次访问A城池时，在里面做了登记，记录了我的档案和信息，并存进了A城的仓库，但是下次我来，被分配到了B城池，结果B城里面没有了我的信息，他们就把我拒之城外了，所以，后来就需要快递员在这些城池之间运送这些货物信息，使所有城池的仓库信息同步，这样大家去哪个城都能进了，怎么样，我这个想法牛X吧，这确实撑了一段时间，但是经过不断的实践，这又出现了一些问题，第一个就是要存放这么多的信息就需要建立更多的仓库，这些仓库占用着这些城池的土地，使城池越来越小，人们在城里都活动不开了，第二个问题呢，就是这么多城之间传送信息，需要多少快递人员啊，我们已经雇不了那么多人了，都是雪花花的白银啊，而且也找不到那么多人愿意干这活了，所以，我经过一通彻夜思考，设计把这些仓库从城中拿出，在所有通往城池的道路上，建立这么一片雾气缭绕的云空间，这样大家路过的时候，在这里取出自己的档案信息，拿到城里去就行了。猴哥，你现在拿着我给你的法宝，去取出你的信息吧，拿些这些东西你再进城去。”

悟空心想，原来如此，怪不得我第一次过来的时候什么都没有给我就让我过去了，到了城门前，那几个看门的把我给拦住了，原来是要在这里取出通行证才能过去啊，随后，悟空拿出了cookie法宝，缓存仓库根据法宝中的sessionid取出了悟空的session给了他，悟空揣上session继续踏着探险之路前进。

一路上，八戒又碎碎念道，“其实呢，当初还有几种方案，一种是我把你的个人信息都存放进cookie法宝中，这是早期某宝采用的做法，但是我总觉得这样不够安全，不过，在效率和成本上，这种方法还是不错的。还有一种呢，就是利用负载均衡设备记录你的sessionid，这样根据sessionid，把你送到你之前去的城池中，这种方法呢，虽然比我之前在每座城的仓库间运货物效率要高一些，但也好不到哪去。”

书说简短，悟空来到了主城--“Web城池”，到了城门前，悟空拿出通行证亮了一番，顺利的进入了城池，心想，“看你们再敢拦我，我也是有证的猴了”。进入城中，只见，里面排列着密密麻麻的工厂、一条条错综复杂的传送带，遍地堆放着大大小小的货物，悟空问道，“大猪，这里怎么这么凌乱啊，这些都是什么啊？”

大猪说道，“猴哥，这里就是咱当年取经的天竺国啦，这一条条的传送带会从后方仓库中，把一块块经书模板取出，然后在工厂中，这些模板会拼装成各种各样的经书，之后工厂就可以分装打包了，当然，如果有的人想拿经书送女朋友的话，我们还会提供个性打包服务，让他美美的拿回去，哈哈，到位吧。”

悟空心想，“哟，看来世界还真是进步了，取个经原来这么方便啊。”，没等悟空说话，大猪又道，“猴哥，刚才看你这要进来，我也没跟你打招呼，在你腰间放了个包裹，正好你帮我送了进来，省的我再雇人跑腿了。”，悟空骂道，“你个泼猪，这点便宜还要占你师兄的。”

大猪忙说，“猴哥，别急，这不是也为了让你体验一下入库的感受嘛，你不能跑一趟来还没体会全我的服务，那不亏大了，你说是吧。”

悟空心想，“算了，占点便宜就占点吧，我又不是没少让他占。”，大猪继续说道，“师兄，这个包裹里装的都是我收集的一些经书模板，你把它们放到你右手边的传送带上，它们自然会进入仓库，你什么都不用管了。”，随后，悟空将一块块模板放入传送带，只见这些模板都被传入了一个叫做“写仓库”中，悟空问道，“大猪，这个写仓库是什么？”

大猪心想，“嘿嘿，你可是问到我的经典之作了，我还怕你不问，我没法显摆了。”，急忙说道，“这可是我的一个杰出的设计，想当年，我们的城池中只有那么一个仓库，刚开始还行，来的人不多，带的货物也不多，一切都是有条不紊的运行着，但是，随着到访的人越来越多，麻烦事儿也就来了，有一次，一帮哥们把一大堆货物扔到了传送带上往里存货，结果货物太多把仓库给堵住了，这下可好了，由于仓库口堵住了，取货的兄弟们拿不到货了，存货的兄弟也存不了货了，这里整个一片混乱，我了个天呐，当时那情景，我现在想想都发怵。之后，这样的事情时常会发生，我简直快崩溃了，最后实在没辙了，我就去了趟天宫咨询了一下L大神，我把这里的情况跟L大神一说，L大神眼睛一闪，一语道破天机：猪啊，你用两个仓库，一个存，一个取不就行了。虽然他当时骂我是猪，这事儿有点不能忍，但L神毕竟是L神，我若把这个仓库拆成两个，一个负责进货，一个负责出货，这两个仓库之间建立几条传送带把两边的货物同步，这不就解决堵口的问题了么，我当时兴奋不已，立马根据这个思路，建设了现在的读写两个仓库。”

悟空笑道，“猪啊，看来你果然是猪啊，不过看来你这个想法不错，我看现在那么多人在取货，我这边往里存的还是那么顺畅，不赖，不赖。”

大猪说道，“猴哥，这都是小事儿，我这不还计划，这要是在读仓库前面再放一个仓库，把大家经常取的货物放在里面，这样不是大伙的取货时间更短了么，你说我是不是天才啊。”

悟空骂道，“你别得意忘形了，不过你说的这个方法倒还真心不错，以后可以试试。”，随后，悟空到了取货口，拿了一个精美包装的经文，开开心心的离开了。

出来后，悟空对大猪说道，“不错，别看里面人挺多，但我这一路还算顺畅，这趟旅行还是十分开心的，不像我们花果山那样，一到十一小长假，基本人山人海，走也走不动了。大猪，你还是有两把刷子的嘛。”

八戒笑道，“猴哥，你还是太抬举我了，我这个吧，也就是个一般的网站，现在咱们全世界，比我这大的多得网站可多了去了，人家那架构建设的更邪乎，你要是对这感兴趣，哪天我也带你逛逛去？”

悟空说，“好啊，可今天不行了，我是背着管理师傅跑出来的，时间长了被发现了，我这月养老金可就泡汤了，我得赶紧回去了。今儿真是长见识了，原来网络里面这么有趣，也罢，今儿我也不从天上回去了，上面飞机太多，好几次差点撞死我，我就从网络回去，ok，哟哟，一步两步，似魔鬼的步伐，歹俺老孙走也！”

大猪大急，“哎哟，这猴哥，性子简直是太急了，说走就走啊，这下完了，网络里的路可比天上复杂多了，我估计他这下真心回不到花果山了，这可不是扣一个月养老金的问题了，得了，我也只能在这儿祝福猴兄了。”，随后，大猪看了看表，拿上了手机，屁颠屁颠的下楼吃饭去了。

![架构图](http://7u2oul.com1.z0.glb.clouddn.com/架构图.png)